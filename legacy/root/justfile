set shell := ["bash", "-eu", "-o", "pipefail", "-c"]

bin := "bin/ralph"

default:
  @just --list

fmt:
  gofmt -w cmd internal

tidy:
  go mod tidy

test:
  go test ./...

build:
  mkdir -p bin
  go build -o "{{bin}}" ./cmd/ralph

install:
  go install ./cmd/ralph

# Create a symlink to `bin/ralph` so you can run `ralph` from your terminal.
# Make sure `link_dir` is on your PATH.
link link_dir="$HOME/.local/bin": build
  link_dir="{{link_dir}}"
  link_dir="$(python3 -c 'import os,sys; print(os.path.expanduser(sys.argv[1]))' "$link_dir")"
  mkdir -p "$link_dir"
  ln -sf "$(pwd)/{{bin}}" "$link_dir/ralph"
  echo "linked: $link_dir/ralph -> $(pwd)/{{bin}}"

unlink link_dir="$HOME/.local/bin":
  link_dir="{{link_dir}}"
  link_dir="$(python3 -c 'import os,sys; print(os.path.expanduser(sys.argv[1]))' "$link_dir")"
  rm -f "$link_dir/ralph"
  echo "removed: $link_dir/ralph"

check-link link_dir="$HOME/.local/bin":
  link_dir="{{link_dir}}"
  link_dir="$(python3 -c 'import os,sys; print(os.path.expanduser(sys.argv[1]))' "$link_dir")"
  target="$link_dir/ralph"
  expected="$(pwd)/{{bin}}"
  expected_real="$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$expected")"

  if [ ! -L "$target" ]; then
  echo "missing symlink: $target" >&2
  exit 1
  fi

  actual_real="$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$target")"
  if [ "$actual_real" != "$expected_real" ]; then
  echo "bad symlink: $target -> $actual_real (expected $expected_real)" >&2
  exit 1
  fi

  if [ ! -x "$actual_real" ]; then
  echo "not executable: $actual_real" >&2
  exit 1
  fi

  echo "ok: $target -> $actual_real"

check-which link_dir="$HOME/.local/bin": check-link
  link_dir="{{link_dir}}"
  link_dir="$(python3 -c 'import os,sys; print(os.path.expanduser(sys.argv[1]))' "$link_dir")"
  expected="$link_dir/ralph"
  actual="$(command -v ralph || true)"
  if [ -z "$actual" ]; then
  echo "ralph not found on PATH" >&2
  exit 1
  fi
  if [ "$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$actual")" != "$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$expected")" ]; then
  echo "command -v ralph -> $actual (expected $expected)" >&2
  exit 1
  fi
  echo "ok: command -v ralph -> $actual"

path-hint link_dir="$HOME/.local/bin":
  link_dir="{{link_dir}}"
  link_dir="$(python3 -c 'import os,sys; print(os.path.expanduser(sys.argv[1]))' "$link_dir")"
  echo "Add this to your shell config:"
  echo "  export PATH=\"$link_dir:\$PATH\""

doctor:
  command -v go >/dev/null || (echo "missing: go" >&2; exit 1)
  command -v git >/dev/null || (echo "missing: git" >&2; exit 1)
  command -v codex >/dev/null || echo "warn: codex not found (executor.kind=codex will fail)"
  command -v claude >/dev/null || echo "warn: claude not found (executor.kind=claude will fail)"
  echo "ok"

clean:
  rm -rf bin
